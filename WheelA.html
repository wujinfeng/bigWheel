{% load static from staticfiles %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title> </title>
    <link rel="stylesheet" href="{% static 'css/act/basic.css' %}?v=322">
    <link rel="stylesheet" href="{% static 'css/act/frozen.css' %}?v=322">
    <link rel="stylesheet" href="{% static 'css/act/index.css' %}?v=324">
    <link rel="stylesheet" href="{% static 'css/act/GB-css3-wheel.css' %}?v=322">
    <link rel="stylesheet" href="http://icono-49d6.kxcdn.com/icono.min.css">
</head>
<body ontouchstart>
<!--banner1-->
<div class="ui-row-flex ui-row-flex-ver banner1">
    <div class="ui-col">
        <div class="banner1img"></div>
    </div>
</div>
<!--banner2-->
<div class="ui-row-flex ui-row-flex-ver banner2">
    <div class="ui-col">
        <div class="banner2img"></div>
    </div>
</div>
<!--主题样式设置-->
<div class="theme-default">
    <!-- 大转盘 -->
    <div class="ui-row-flex ui-row-flex-ver dazhuanpan">
        <div class="ui-col">
            <section class="gb-wheel-container" id="gbWheel">
                <div class="gb-wheel-content gb-wheel-run">
                    <ul class="gb-wheel-line">
                        <li class="gb-wheel-litem" style="transform: rotate(0.08333333333333333turn)"></li>
                        <li class="gb-wheel-litem" style="transform: rotate(0.25turn)"></li>
                        <li class="gb-wheel-litem" style="transform: rotate(0.41666666666666663turn)"></li>
                        <li class="gb-wheel-litem" style="transform: rotate(0.5833333333333334turn)"></li>
                        <li class="gb-wheel-litem" style="transform: rotate(0.75turn)"></li>
                        <li class="gb-wheel-litem" style="transform: rotate(0.9166666666666666turn)"></li>
                    </ul>
                    <div class="gb-wheel-list">
                        <div class="gb-wheel-item">
                            <p class="gb-wheel-icontent" style="transform: rotate(0turn)">0</p>
                        </div>
                        <div class="gb-wheel-item">
                            <p class="gb-wheel-icontent" style="transform: rotate(0.16666666666666666turn)">1</p>
                        </div>
                        <div class="gb-wheel-item">
                            <p class="gb-wheel-icontent" style="transform: rotate(0.3333333333333333turn)">2</p>
                        </div>
                        <div class="gb-wheel-item">
                            <p class="gb-wheel-icontent" style="transform: rotate(0.5turn)">3</p>
                        </div>
                        <div class="gb-wheel-item">
                            <p class="gb-wheel-icontent" style="transform: rotate(0.6666666666666666turn)">4</p>
                        </div>
                        <div class="gb-wheel-item">
                            <p class="gb-wheel-icontent" style="transform: rotate(0.8333333333333333turn)">5</p>
                        </div>
                    </div>
                </div>
                <a href="javascript:void(0);" class="gb-wheel-btn" id="gbLottery"> </a>
            </section>
        </div>
    </div>
    <!-- 提示次数 -->
    <div class="tipcount textcenter">
        您还有 <span id='remainCount'>0</span>次机会!
    </div>

    <!-- 奖品列表 -->
    <div class="style-title textcenter">奖品列表</div>
    <div class="ui-row-flex ui-whitespace ui-row-flex-ver award textcenter">
        <div class="ui-tab" id="tab1">
            <ul class="ui-tab-nav ui-border-b">
                <li class="current">我的奖品</li>
                <li>最新中奖</li>
            </ul>
            <ul class="ui-tab-content" style="width:300%">
                <li>
                  <ul class='mylist'>
                        <li>暂无</li>
                    </ul>
                </li>
                <li>
                    <ul class='list'>
                        <li>183****6618-中华烟</li>
                        <li>130****6633-台灯</li>
                        <li>150****6666-矿泉水</li>
                        <li>170****2233-面膜</li>
                        <li>182****1525-懒人支架</li>
                        <li>153****0011-耳机</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <!-- 活动规则 -->
    <div class="style-title textcenter">活动规则</div>
    <div class="ui-row-flex ui-whitespace ui-row-flex-ver rule">
        <div class="ui-col" style="height: auto;">
            <div>
                <p>活动时间：</p>
                <div id='acttime'></div>
                <p>活动规则：</p>
                <div id="rule"></div>
            </div>
        </div>
    </div>

    <!-- 广告弹出框 -->
    <div class="ui-dialog ad-dialog">
        <div class="ui-dialog-cnt">
            <header class="ui-border-b">
                <i class="ui-dialog-close" data-role="button"></i>
            </header>
            <div class="">
                <div class="adimg"></div>
            </div>
        </div>
    </div>

    <!-- 中奖弹出框 -->
    <div class="ui-dialog win"  style="position: absolute;">
        <div class="ui-dialog-cnt">
            <header class="ui-dialog-hd ui-border-b">
                <h3 id="subtitle"></h3>
                <i class="ui-dialog-close" data-role="button"></i>
            </header>
            <div class="ui-dialog-bd">
                <h4 class="award-name"></h4>
                <p class="textcenter award-copy"></p>
                <div>
                    <div class="ui-form ui-border-t">
                        <form method="" action="">
                            <div class="ui-form-item ui-form-item-pure ui-border-b">
                                <input type="text" id="name" placeholder="姓名" name="name"  value="">
                            </div>
                            <div class="ui-form-item ui-form-item-pure ui-border-b">
                                <input type="number" id="mobile" name="mobile" placeholder="手机号"  value="">
                            </div>
                            <div class="ui-form-item ui-form-item-pure ui-border-b">
                                <input type="text" id="address" name="address" placeholder="地址" value="">
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="ui-dialog-ft ui-btn-group">
                <button type="button" data-role="button" id="submitMyInfo">提交</button>
            </div>
        </div>
    </div>

    <!-- 提交完成弹出框 -->
    <div class="ui-dialog finish-dialog">
        <div class="ui-dialog-cnt">
            <header class="ui-dialog-hd ui-border-b">
                <h3 class="">提交完成</h3>
                <i class="ui-dialog-close" data-role="button"></i>
            </header>
            <div class="ui-dialog-bd">
                <p class="textcenter" id="oktip"></p>
                <div>
                    <div class="finish-img"></div>
                </div>
            </div>
        </div>
    </div>
 	<!--分享按钮-->
    <div class="ui-btn-wrap share-btn">
        <button class="ui-btn-s" id='shareBtn'>分享</button>
    </div>
    <!--分享弹出框-->
    <div class="ui-dialog share-dialog">
        <div class="ui-dialog-cnt">
            <header class="ui-border-b">
                <i class="ui-dialog-close" data-role="button"></i>
            </header>
            <div class="">
                <div class="shareimg"><img src="http://www.xiqueyun.cn/static/uploads/img/share.png"></div>
            </div>
        </div>
    </div>
</div>

<script src="{% static 'lib/act/zepto.min.js' %}?v=322"></script>
<script src="{% static 'js/act/frozen.js' %}?v=322"></script>
<script src="{% static 'js/act/autolist.js' %}?v=322"></script>
<script src="https://cdn.bootcss.com/moment.js/2.21.0/moment.min.js"></script>
<script>
    $(function () {
    	var WEBURL = '/';

        function getQuery(name){
            　 var reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
            var r = window.location.search.substr(1).match(reg);//从?之后开始匹配如getQuery(courseid)
                                           //返回一个数组["courseid=8","","8","&",index:0,input:"courseid=8"]
               if (r!=null) return unescape(r[2]); return null;
            }

        // 旋转
        var icount = 0;
        var isRotateing = false;
        var len = 6;
        var nextLottery=false;
        var nextAwardId = '';  // 下次中奖id
        var award_id='';     // 中奖id
        var activity_id = ''; // 活动id
        var token = '';     // 活动token
        var mymobile = '';
        var user_win_count_already = 0; //用户剩余次数
        token = getQuery('token') || '';
        console.log('token:'+token)

        /*奖品列表*/
        $('.mylist').autolist();
        var tab = new fz.Scroll('.ui-tab', {role: 'tab'});
        tab.on('beforeScrollStart', function (from, to) {
            console.log(from, to);
        });
        tab.on('scrollEnd', function (curPage) {
            /*奖品列表滚动*/
            console.log('curPage:'+curPage);
            if (curPage===0) {
                if (mymobile) {                    
                     $('.mylist').autolist();
                }
            }else{
                  $('.list').autolist();
            }
        });

        /*广告弹出框*/
        function adDialog(duration,data) {
            if (data && duration && (duration != 0)) {
            	var id = data.id || '';
	            var img = data.pic || '';
	            var type = data.type || 1; // 点击会跳转
			    var url = data.url || ''; // 跳转url
	            if (id) {
	                var href = '';
	                if (type === 2) {
	                    href = 'href="' + WEBURL +'act/red_to?id='+ id + '&url='+ url + '"';
	                }
	                $('.adimg').html('<a ' + href + '><img src="'+ WEBURL + img + '"></a>');
            		$(".ad-dialog").dialog('show');
	                setTimeout(function () {
	                    $(".ui-dialog").dialog('hide');
	                }, Number(duration) * 1000);
            	}               
            }
        }

        var $remainCount = $('#remainCount');
        var userWinCount = 0;  // 用户抽奖次数
        var allAward = [];     // 奖品列表
        var winAwardIndex = 0; // 中奖索引
        // 获取整体页面数据
        $.post(WEBURL+'act/get_act_awd/', {token:token}, function (response, status, xhr) {
            console.log(response)
            if(response.code === 0) {
                $.post(WEBURL+'act/lottery/', {token:token}, function (aw, status, xhr) {
                    console.log(aw)
                    if (aw.code === 0) {
                        var activity = response.data.result[0].activity || {};       // 活动
                        var award = response.data.result[1].award || [];             // 奖品列表
                        var banner = response.data.result[2].banner || [];           // banner
                        award_id = aw.data.award_id || '';                         // 中奖id
                        var duration = activity.popup_duration || 0;               // 显示时间大于0则显示
                        var user_win_count = activity.user_count_limit || 0;      // 用户抽奖次数
                        var share = activity.share || 1;                 // 分享
                        activity_id = activity.id || '';                 //  activity id
                        document.title = activity.name;
                        console.log('activity_id:'+activity_id)
                        console.log('1 award_id:'+award_id)
                        console.log('user_win_count :' + user_win_count )
                        $('#rule').html(activity.rule ? (activity.rule.replace(/\n/g,'<br/>')): '');				  // 活动规则
                        $('#acttime').html(moment(activity.begin_time).format('YYYY-MM-DD HH:mm:ss') +' - ' + moment(activity.end_time).format('YYYY-MM-DD HH:mm:ss') ) ;   // 活动时间
                        if (activity.okpic) {
                            $('.finish-img').html('<img src="'+WEBURL+(activity.okpic || '')+'">');
                        }
                        if(activity.bgpic){   //设置背景图
                            $('.theme-default').css('background-image','url('+WEBURL+activity.bgpic+')')
                        }
                        $('#oktip').html(activity.oktip || '')
                        $('#subtitle').html(activity.subtitle || '')
                        setTurn(activity);
                        setShare(share);
                        adDialog(duration, banner.popup); 			// 设置广告
                        setBanner('.banner2img', '.banner2', banner.banner_2); // set banner2
                        setBanner('.banner1img', '.banner1', banner.banner_1); // set banner1
                        setStorage(activity);
                        for(var i=0; i<award.length; i++){  // 奖品列表
                            allAward.push({id:award[i].id, index:i, name:award[i].name, src: WEBURL + award[i].pic, award_copy:award[i].award_copy})
                            if(award[i].id === award_id){
                                winAwardIndex = i;     // 得到中奖索引
                                $('.award-name').html(award[i].name)
                                $('.award-copy').html(award[i].award_copy)
                            }
                        }
                        start();
                    }
                });
            }
        });
        function setStorage(activity) {
            var user_count_limit = activity.user_count_limit || 0;      // 用户抽奖次数
            var user_win_count_already = window.localStorage.getItem('user_win_count_already'+token);
            var today = moment().format('YYYY-MM-DD');
            var localToday =  window.localStorage.getItem('today'+token);
            if(user_win_count_already === null){ // 第一次打开活动
                user_win_count_already = user_count_limit;
                window.localStorage.setItem('old_user_count_limit'+token, user_count_limit.toString() ) //设置抽奖次数原始值
                window.localStorage.setItem('user_win_count_already'+token, user_win_count_already.toString() ) //设置用户剩余抽奖次数
                window.localStorage.setItem('type_limit'+token, activity.type_limit.toString() )   // 抽奖次数类型1.全程活动，2每日
                window.localStorage.setItem('today'+token, moment().format('YYYY-MM-DD') )   // 设置抽奖的时间
            }else{ // 第二次打开活动
                var old_user_count_limit = Number(window.localStorage.getItem('old_user_count_limit'+token));
                if(old_user_count_limit !== user_count_limit ){
                    window.localStorage.setItem('old_user_count_limit'+token, user_count_limit.toString() ); //设置抽奖次数原始值
                    window.localStorage.setItem('user_win_count_already'+token, user_count_limit.toString() ) //设置用户剩余抽奖次数
                }else{
                    var type_limit = window.localStorage.getItem('type_limit'+token);
                    if(type_limit === 1){ // 全程
                        window.localStorage.setItem('user_win_count_already'+token, user_win_count_already.toString() ) //设置用户剩余抽奖次数
                    }else{ // 每日，更新每日的抽奖次数
                        if(today !== localToday){
                            window.localStorage.setItem('today'+token, today)   // 设置抽奖的时间
                            window.localStorage.setItem('user_win_count_already'+token, user_count_limit.toString() ) //设置用户剩余抽奖次数
                        }else{
                            window.localStorage.setItem('user_win_count_already'+token, user_win_count_already.toString() ) //设置用户剩余抽奖次数
                        }
                    }
                }
            }
            var showUserWinCount = window.localStorage.getItem('user_win_count_already'+token);
            $remainCount.text(showUserWinCount);    // 设置页面显示
            userWinCount = Number(showUserWinCount); // 传给全局变量
        }

        // 设置分享
        function setShare(share){
        	if(share===2){  // 显示
        		$('.share-btn').show();
        	}
        }
        // 设置转盘图背景
        function setTurn(activity) {
            var turpic = activity.turpic || '';
            var arrpic = activity.arrpic || '';
            $('#gbWheel').css('background-image','url('+WEBURL+turpic+')');
            $('#gbLottery').css('background-image','url('+WEBURL+arrpic+')');
        }

        // 设置banner
        function setBanner(bannerimg, banner, data) {
            if(data){
                var banner_id = data.id || '';
                var banner_img = data.pic || "";
                var banner_type = data.type || 1; // 点击不会跳转
                var url = data.url || ''; // 跳转url
                if (banner_id) {
                    var href = '';
                    if (banner_type === 2) {
                        href = 'href="' + WEBURL +'act/red_to?id='+ banner_id + '&url='+ url + '"';
                    }
                    $(bannerimg).html('<a ' + href + '><img src="'+ WEBURL + banner_img + '"></a>')
                } else {
                    $(banner).hide()
                }
            }else{
                $(banner).hide()
            }
        }

        /*提交用户填写信息*/
        $('#submitMyInfo').tap(function (event) {
            event.stopPropagation();
            submitMyInfo();
        });
       function submitMyInfo() {
            var name = $('#name').val() || '';
            var address = $('#address').val() || '';
            var mobile = $('#mobile').val() || '';
             if (!name || !address || !mobile) {
                 $(".win").addClass('show-dialog');       // 弹出中奖
                 $.tips({content: '请填写完整信息！',stayTime: 2000,type: "error"})
                 setTimeout(function (){
                     $(".win").removeClass('show-dialog').addClass('show');
                 }, 2200);
                return
            }
            if (name && address && mobile){
                if(/^1[0-9]{10}$/.test(Number(mobile)) ){
                     var data = {'activity_id':activity_id, 'award_id':award_id, 'name': name, 'mobile': mobile, 'address': address};
                     $.post(WEBURL + 'act/win/', data, function (result) {
                        if (result.code === 0) {
                            $(".win").dialog('hide');
                            setMyAward(mobile); // 我的奖品
                            $(".finish-dialog").dialog('show');                            
                        } else {
                            $(".win").addClass('show-dialog');       // 弹出中奖
                            $.tips({content: '请填写完整信息！',stayTime: 2000,type: "error"})
                            setTimeout(function (){
                                $(".win").removeClass('show-dialog').addClass('show');
                            }, 2200);
                        }
                    })
                }else{
                    $(".win").addClass('show-dialog');       // 弹出中奖
                    $.tips({content: '请填写11位手机号！',stayTime: 2000,type: "error"})
                    setTimeout(function (){
                        $(".win").removeClass('show-dialog').addClass('show');
                    }, 2200);
                }
            }else{
                $(".win").addClass('show-dialog');       // 弹出中奖
                $.tips({content: '请填写完整信息！',stayTime: 2000,type: "error"})
                setTimeout(function (){
                    $(".win").removeClass('show-dialog').addClass('show');
                }, 2200);
            }
        }

        function setMyAward(mobile){
            mymobile = mobile;
          $.get(WEBURL + 'act/get_my_detail/?mobile='+mobile+'&timestamp='+Date.now(), function (response, status, xhr) {
                    console.log('my awards:')
                    console.log(response)
                    if(response.code === 0) {
                        var result = response.data.result;
                        var html = '';
                        for(var i=0; i<result.length; i++){
                            html += '<li>'+mobile+' - '+result[i].award_name+'</li>'
                        }
                        if (html) {
                             $('.mylist').html(html);
                         }
                    }
                })
        }

        function setNewAward(){
          $.get(WEBURL + 'act/get_new_detail/?timestamp='+Date.now(), function (response, status, xhr) {
                    console.log('new awards:')
                    console.log(response)
                    if(response.code === 0) {
                        var result = response.data.result;
                        var html = '';
                        for(var i=0; i<result.length; i++){
                            html += '<li>'+result[i].mobile+' - '+result[i].award_name+'</li>'
                        }
                        if (html) {
                             $('.list').html(html);
                         }
                    }
                })
        }
        setNewAward();

        /*点击分享按钮*/
         $('#shareBtn').tap(function () {
            $(".share-dialog").dialog('show');
        });
         // 下次抽奖
        function nextLotteryRequest() {
             $.post(WEBURL + 'act/lottery/', {token:token}, function (response, status, xhr) {
                 console.log(response)
                 if(response.code === 0) {
                     nextAwardId = response.data.award_id || '';
                     console.log('nextLotteryRequest:id'+nextAwardId)
                 }else{
                    nextAwardId = ''
                 }
             });
         }

        function start() {
            // 奖品配置
            var awards =  allAward;
               /*[
                    {'index': 0, 'name': '耳机', 'src': './gbcss3/img/1.png'},
                    {'index': 1, 'name': 'iPhone', 'src': './gbcss3/img/2.png'}
                ]*/
             len = awards.length;
            var turnNum = 1 / len;  // 文字旋转 turn 值
            var gbWheel = document.getElementById('gbWheel'),
                lineList = gbWheel.querySelector('ul.gb-wheel-line'),
                itemList = gbWheel.querySelector('.gb-wheel-list'),
                lineListHtml = [],
                itemListHtml = [];
            var transform = preTransform();
            awards.forEach(function (v, i, a) {
                // 分隔线
                lineListHtml.push('<li class="gb-wheel-litem" style="' + transform + ': rotate(' + (i * turnNum + turnNum / 2) + 'turn)"></li>');
                // 奖项
                itemListHtml.push('<div class="gb-wheel-item">');
                itemListHtml.push('<div class="gb-wheel-icontent" style="' + transform + ': rotate(' + (i * turnNum) + 'turn)">');

				itemListHtml.push('<p class="gb-wheel-itext">');
                itemListHtml.push(v.name);
                itemListHtml.push('</p>');

                itemListHtml.push('<p class="gb-wheel-iicon">');
                //itemListHtml.push('<i class="'+v.name+'"></i>');
                itemListHtml.push('<img class="rotate-img" src="' + v.src + '"></>');
                itemListHtml.push('</p>');
           
                itemListHtml.push('</div>');
                itemListHtml.push('</div>');
            });
            lineList.innerHTML = lineListHtml.join('');
            itemList.innerHTML = itemListHtml.join('');
        }

        document.getElementById('gbLottery').onclick = function () {
            var transform = preTransform();
            if(isRotateing){
                $.tips({content: '心急吃不了热豆腐！', stayTime: 2000, type: "success"});
                return;
            }
            icount++;
            userWinCount--;   // 抽一次，次数少一次
            if (userWinCount < 0) {
                $.tips({content: '已经抽取完毕', stayTime: 2000, type: "error"});
                return
            }
            $remainCount.text(userWinCount);  // 设置界面显示抽奖次数
            window.localStorage.setItem('user_win_count_already'+token, userWinCount.toString() ); //设置用户剩余抽奖次数
            if(nextLottery){
                winAwardIndex = 0;
                award_id = nextAwardId;
                for(var n=0; n<allAward.length; n++){  // 奖品列表
                    if(allAward[n].id === award_id){
                        winAwardIndex = n;     // 得到中奖索引
                        $('.award-name').html(allAward[n].name)
                        $('.award-copy').html(allAward[n].award_copy)
                        break;
                    }
                }
            }
            var winNum = winAwardIndex ;     // 12点方向 从零开始计数 抽奖计数 顺时针
            var deg = 2520 * icount - (1 / len) * winNum * 360;
            document.getElementById('gbWheel').querySelector('.gb-wheel-content').style[transform] = 'rotate(' + deg + 'deg)';
            isRotateing = true;         // 正在旋转
            nextLotteryRequest();       // 下次抽奖
            nextLottery=true;
            setTimeout(function () {
                isRotateing = false;    // 停止旋转
                console.log('winNum:'+winNum)
                console.log('2 award_id:'+award_id)
                if( award_id !== '' ){
                    $(".win").dialog('show');       // 弹出中奖
                    $("#name").focus();
                }else{
                    $.tips({content: '谢谢您的参与！', stayTime: 2000, type: "error"});
                }
            },7000)
        };

        function preTransform() {
            var cssPrefix,
                vendors = {
                    '': '',
                    Webkit: 'webkit',
                    Moz: '',
                    O: 'o',
                    ms: 'ms'
                },
                testEle = document.createElement('p'),
                cssSupport = {};
            // 嗅探特性
            Object.keys(vendors).some(function (vendor) {
                if (testEle.style[vendor + (vendor ? 'T' : 't') + 'ransform'] !== undefined) {
                    cssPrefix = vendor ? '-' + vendor.toLowerCase() + '-' : '';
                    return true;
                }
            });
            /**
             * [兼容CSS前缀]
             * @param  {[type]} name [description]
             * @return {[type]}      [description]
             */
            function normalizeCss(name) {
                name = name.toLowerCase();
                return cssPrefix ? cssPrefix + name : name;
            }
            cssSupport = {
                transform: normalizeCss('Transform'),
            }
            return cssSupport.transform;
        }
    })
</script>
</body>
</html>
