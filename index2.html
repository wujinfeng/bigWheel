<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>抽奖</title>
    <link rel="stylesheet" href="./frozenui/css/basic.css">
    <link rel="stylesheet" href="./frozenui/css/frozen.css">
    <link rel="stylesheet" href="./css/index.css">
    <link rel="stylesheet" href="./gbcss3/css/GB-css3-wheel.css">
    <link rel="stylesheet" href="http://icono-49d6.kxcdn.com/icono.min.css">
</head>
<body ontouchstart>
<!--banner1-->
<div class="ui-row-flex ui-row-flex-ver banner1">
    <div class="ui-col">
        <div class="banner1img"></div>
    </div>
</div>
<!--banner2-->
<div class="ui-row-flex ui-row-flex-ver banner2">
    <div class="ui-col">
        <div class="banner2img"></div>
    </div>
</div>
<!--主题样式设置-->
<div class="theme-default">
    <!-- 大转盘 -->
    <div class="ui-row-flex ui-row-flex-ver dazhuanpan">
        <div class="ui-col">
            <section class="gb-wheel-container" id="gbWheel">
                <div class="gb-wheel-content gb-wheel-run">
                    <ul class="gb-wheel-line">
                        <li class="gb-wheel-litem" style="transform: rotate(0.08333333333333333turn)"></li>
                        <li class="gb-wheel-litem" style="transform: rotate(0.25turn)"></li>
                        <li class="gb-wheel-litem" style="transform: rotate(0.41666666666666663turn)"></li>
                        <li class="gb-wheel-litem" style="transform: rotate(0.5833333333333334turn)"></li>
                        <li class="gb-wheel-litem" style="transform: rotate(0.75turn)"></li>
                        <li class="gb-wheel-litem" style="transform: rotate(0.9166666666666666turn)"></li>
                    </ul>
                    <div class="gb-wheel-list">
                        <div class="gb-wheel-item">
                            <p class="gb-wheel-icontent" style="transform: rotate(0turn)">0</p>
                        </div>
                        <div class="gb-wheel-item">
                            <p class="gb-wheel-icontent" style="transform: rotate(0.16666666666666666turn)">1</p>
                        </div>
                        <div class="gb-wheel-item">
                            <p class="gb-wheel-icontent" style="transform: rotate(0.3333333333333333turn)">2</p>
                        </div>
                        <div class="gb-wheel-item">
                            <p class="gb-wheel-icontent" style="transform: rotate(0.5turn)">3</p>
                        </div>
                        <div class="gb-wheel-item">
                            <p class="gb-wheel-icontent" style="transform: rotate(0.6666666666666666turn)">4</p>
                        </div>
                        <div class="gb-wheel-item">
                            <p class="gb-wheel-icontent" style="transform: rotate(0.8333333333333333turn)">5</p>
                        </div>
                    </div>
                </div>
                <a href="javascript:void(0);" class="gb-wheel-btn" id="gbLottery">抽奖</a>
            </section>
        </div>
    </div>
    <!-- 提示次数 -->
    <div class="tipcount textcenter">
        您还有 <span id='remainCount'>0</span>次机会!
    </div>

    <!-- 奖品列表 -->
    <div class="style-title textcenter">奖品列表</div>
    <div class="ui-row-flex ui-whitespace ui-row-flex-ver award textcenter">
        <div class="ui-tab" id="tab1">
            <ul class="ui-tab-nav ui-border-b">
                <li class="current">我的奖品</li>
                <li>最新中奖</li>
            </ul>
            <ul class="ui-tab-content" style="width:300%">
                <li>暂无</li>
                <li>
                    <ul class='list'>
                        <li>18310016618-中华烟一盒</li>
                        <li>13015266633-啤酒一瓶</li>
                        <li>15025256666-矿泉水一瓶</li>
                        <li>17045662233-面膜一套</li>
                        <li>18233661525-懒人支架</li>
                        <li>15322100011-苹果手机贴膜</li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>

    <!-- 活动规则 -->
    <div class="style-title textcenter">活动规则</div>
    <div class="ui-row-flex ui-whitespace ui-row-flex-ver rule">
        <div class="ui-col">
            <div>
                活动时间：<span id='acttime'></span>
                <p>活动规则：</p>
                <div id="rule"></div>
            </div>
        </div>
    </div>

    <!-- 广告弹出框 -->
    <div class="ui-dialog ad-dialog">
        <div class="ui-dialog-cnt">
            <header class="ui-border-b">
                <i class="ui-dialog-close" data-role="button"></i>
            </header>
            <div class="">
                <div class="adimg"></div>
            </div>
        </div>
    </div>

    <!-- 中奖弹出框 -->
    <div class="ui-dialog reset win">
        <div class="ui-dialog-cnt">
            <header class="ui-dialog-hd ui-border-b">
                <h3 class="">恭喜你中奖啦！</h3>
                <i class="ui-dialog-close" data-role="button"></i>
            </header>
            <div class="ui-dialog-bd">
                <h4 class="award-name"></h4>
                <p class="textcenter award-copy"></p>
                <div>
                    <div class="ui-form ui-border-t">
                        <form>
                            <div class="ui-form-item ui-form-item-pure ui-border-b">
                                <input type="text" id="name" placeholder="姓名"  value="">
                                <a class="ui-icon-close hidden"></a>
                            </div>
                            <div class="ui-form-item ui-form-item-pure ui-border-b">
                                <input type="number" id="mobile" placeholder="手机号"  value="">
                                <a class="ui-icon-close hidden"></a>
                            </div>
                            <div class="ui-form-item ui-form-item-pure ui-border-b">
                                <input type="text" id="address" placeholder="地址" value="">
                                <a class="ui-icon-close hidden "></a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="ui-dialog-ft">
                <button type="button" id="submitInfo">提交</button>
            </div>
        </div>
    </div>

    <!-- 提交完成弹出框 -->
    <div class="ui-dialog reset finish-dialog">
        <div class="ui-dialog-cnt">
            <header class="ui-dialog-hd ui-border-b">
                <h3 class="ui-txt-warning">提交完成</h3>
                <i class="ui-dialog-close" data-role="button"></i>
            </header>
            <div class="ui-dialog-bd">
                <p class="ui-txt-warning textcenter">请关注二维码获取奖品状态</p>
                <div>
                    <div class="finish-img"></div>
                </div>
            </div>
        </div>
    </div>
 	<!--分享按钮-->
    <div class="ui-btn-wrap share-btn">
        <button class="ui-btn-s" id='shareBtn'>分享</button>
    </div>
    <!--分享弹出框-->
    <div class="ui-dialog share-dialog">
        <div class="ui-dialog-cnt">
            <header class="ui-border-b">
                <i class="ui-dialog-close" data-role="button"></i>
            </header>
            <div class="">
                <div class="shareimg"><img src="http://www.xiqueyun.cn/static/uploads/img/share.png"></div>
            </div>
        </div>
    </div>
</div>

<script src="./frozenui/lib/zepto.min.js"></script>
<script src="./frozenui/js/frozen.js"></script>
<script src="./js/autolist.js"></script>

<script>
    $(function () {
        var award_id='';     // 中奖id
        var award_name='';     // 中奖id
        var activity_id = ''; // 活动id

        /*奖品列表*/
        var tab = new fz.Scroll('.ui-tab', {role: 'tab'});
        tab.on('beforeScrollStart', function (from, to) {
            console.log(from, to);
        });
        tab.on('scrollEnd', function (curPage) {
            console.log(curPage);
        });

        /*广告弹出框*/
        function adDialog(duration,data) {
            if (duration && duration != 0) {
            	var id = data.id || '';
	            var img = data.pic || '';
	            var type = data.type || 1; // 点击会跳转
	            if (id) {
	                var href = '';
	                if (type === 2) {
	                    href = 'href="/ad/' + banner_id + '"';
	                }
	                $('.adimg').html('<a ' + href + '><img src="http://www.xiqueyun.cn/' + img + '"></a>')
            		$(".ad-dialog").dialog('show');                
	                setTimeout(function () {
	                    $(".ui-dialog").dialog('hide');
	                }, Number(duration) * 1000);
            	}               
            }
        }

        var $remainCount = $('#remainCount');
        var userWinCount = 0;  // 用户抽奖次数
        var allAward = [];     // 奖品列表
        var winAwardIndex = 0; // 中奖索引
        // 获取整体页面数据
        $.post('http://www.xiqueyun.cn/act/get_act_awd/', {token:token}, function (response, status, xhr) {
            console.log(response)
            if(response.code === 0) {
                var activity = response.data.result[0].activity || {};       // 活动
                var award = response.data.result[1].award || [];             // 奖品列表
                var banner = response.data.result[2].banner || [];           // banner
                award_id = response.data.award_id;                         // 中奖id
                var duration = activity.popup_duration || 0;               // 显示时间大于0则显示
                var user_win_count = activity.user_count_limit || 0;      // 用户抽奖次数
                var share = activity.share || 1;                 // 分享

                $('#rule').html(activity.rule || '') ; 					  // 活动规则
                $('#acttime').html(new Date(activity.begin_time).toLocaleTimeString() +' - ' + new Date(activity.end_time).toLocaleTimeString()) ;   // 活动时间
                if (activity.okpic) {
                	$('#finish-img').html('<img src="http://www.xiqueyun.cn/'+(activity.okpic || '')+'">');
                }			
               
                $remainCount.text(user_win_count);
                userWinCount = user_win_count;
                setShare(share);
                adDialog(duration, banner.popup); 			// 设置广告
                setBanner('.banner2img', '.banner2', banner.banner_1); // set banner2
                setBanner('.banner1img', '.banner1', banner.banner_2); // set banner1
				console.log('userWinCount :' + userWinCount )
                for(var i=0; i<award.length; i++){  // 奖品列表				
                    allAward.push({id:award[i].id, index:i, name:award[i].name, src: 'http://www.xiqueyun.cn/'+award[i].pic})
                    if(award[i].id === award_id){
                        winAwardIndex = i;     // 得到中奖索引
                        $('.award-name').html(award[i].name)
                        $('.award-copy').html(award[i].award_copy)
                    }
                }
                start(allAward);
            }
        });

        // 设置分享
        function setShare(share){
        	if(share===2){  // 显示
        		$('.share-btn').show();
        	}
        }

        // 设置banner
        function setBanner(bannerimg, banner, data) {
            if(!data){
                data={};
            }
            var banner_id = data.id || 2;
            var banner_img = data.pic || "";
            var banner_type = data.type || 2; // 点击会跳转
            if (banner_id) {
                var href = '';
                if (banner_type === 2) {
                    href = 'href="/ad/' + banner_id + '"';
                }
                $(bannerimg).html('<a ' + href + '><img src="http://www.xiqueyun.cn/' + banner_img + '"></a>')
            } else {
                $(banner).hide()
            }
        }
        // 中奖弹出
        function winAward() {
            $(".win").dialog('show');
        }

        /*提交用户填写信息*/
        $('#submitInfo').tap(function () {
            var name = $('#name').val() || '';
            var address = $('#address').val() || '';
            var mobile = $('#mobile').val() || '';
            if (!name || !address || !mobile) {
                 $.tips({content: '请填写完整信息！',stayTime: 2000,type: "error"})
                return
            }
            if (name && address && mobile){
                if(/^1[0-9]{10}$/.test(Number(mobile)) ){
                     var data = {'activity_id':activity_id, 'award_id':award_id, 'name': name, 'mobile': mobile, 'address': address};
                     $.post('http://www.xiqueyun.cn/act/win/', data, function (result) {
                        if (result.code === 0) {
                            $(".win").dialog('hide');
                            $(".finish-dialog").dialog('show');
                        } else {
                             $.tips({content:'提交失败',stayTime:2000, type:"error" })
                        }
                    })
                }else{
                    $.tips({content: '请填写11位手机号！',stayTime: 2000,type: "error"})
                    return
                }
            }else{
                $.tips({content: '请填写完整信息！',stayTime: 2000,type: "error"})
                return
            }
        })

        /*奖品列表滚动*/
        $('.list').autolist();

        function start() {
            // 奖品配置
            var awards =  allAward;
               /*[
                    {'index': 0, 'name': '耳机', 'src': './gbcss3/img/1.png'},
                    {'index': 1, 'name': 'iPhone', 'src': './gbcss3/img/2.png'}
                ]*/
            var len = awards.length;
            var turnNum = 1 / len;  // 文字旋转 turn 值

            var gbWheel = document.getElementById('gbWheel'),
                lineList = gbWheel.querySelector('ul.gb-wheel-line'),
                itemList = gbWheel.querySelector('.gb-wheel-list'),
                lineListHtml = [],
                itemListHtml = [];

            var transform = preTransform();

            awards.forEach(function (v, i, a) {
                // 分隔线
                lineListHtml.push('<li class="gb-wheel-litem" style="' + transform + ': rotate(' + (i * turnNum + turnNum / 2) + 'turn)"></li>');

                // 奖项
                itemListHtml.push('<div class="gb-wheel-item">');
                itemListHtml.push('<div class="gb-wheel-icontent" style="' + transform + ': rotate(' + (i * turnNum) + 'turn)">');

				itemListHtml.push('<p class="gb-wheel-itext">');
                itemListHtml.push(v.name);
                itemListHtml.push('</p>');

                itemListHtml.push('<p class="gb-wheel-iicon">');
                //itemListHtml.push('<i class="'+v.name+'"></i>');
                itemListHtml.push('<img class="rotate-img" src="' + v.src + '"></>');
                itemListHtml.push('</p>');
           
                itemListHtml.push('</div>');
                itemListHtml.push('</div>');
            });
            lineList.innerHTML = lineListHtml.join('');
            itemList.innerHTML = itemListHtml.join('');
            // 旋转
            var i = 0;
            var isRotateing = false;
            document.getElementById('gbLottery').onclick = function () {
                if(isRotateing){
                    $.tips({content: '心急吃不了热豆腐！', stayTime: 2000, type: "success"});
                    return;
                }
                i++;
                userWinCount--;   // 抽一次，次数少一次
                if (userWinCount < 0) {
                    $.tips({content: '已经抽取完毕', stayTime: 2000, type: "error"});
                    return
                }
                $remainCount.text(userWinCount);  // 设置界面显示抽奖次数

                var winNum = winAwardIndex ;     // 12点方向 从零开始计数 抽奖计数 顺时针
                var deg = 2520 * i - (1 / len) * winNum * 360;
                gbWheel.querySelector('.gb-wheel-content').style[transform] = 'rotate(' + deg + 'deg)';
                isRotateing = true;         // 正在旋转
                setTimeout(function () {
                    isRotateing = false;    // 停止旋转
				console.log('winNum:'+winNum)
				console.log('award_id:'+award_id)
                    if( award_id !== '' || winNum !== 0 ){
                        winAward()       // 弹出中奖
                    }else{
                    	$.tips({content: '感谢您的参与！', stayTime: 2000, type: "error"});
                    }
                },7000)
            };

            // console.log(preTransform());
            // transform兼容
            function preTransform() {
                var cssPrefix,
                    vendors = {
                        '': '',
                        Webkit: 'webkit',
                        Moz: '',
                        O: 'o',
                        ms: 'ms'
                    },
                    testEle = document.createElement('p'),
                    cssSupport = {};
                // 嗅探特性
                Object.keys(vendors).some(function (vendor) {
                    if (testEle.style[vendor + (vendor ? 'T' : 't') + 'ransform'] !== undefined) {
                        cssPrefix = vendor ? '-' + vendor.toLowerCase() + '-' : '';
                        return true;
                    }
                });
                /**
                 * [兼容CSS前缀]
                 * @param  {[type]} name [description]
                 * @return {[type]}      [description]
                 */
                function normalizeCss(name) {
                    name = name.toLowerCase();
                    return cssPrefix ? cssPrefix + name : name;
                }
                cssSupport = {
                    transform: normalizeCss('Transform'),
                }
                return cssSupport.transform;
            }

        };
    })
</script>
</body>
</html>